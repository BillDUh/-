<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å–®å­—èƒŒèª¦å·¥å…·</title>

<style>
body{
  margin:0;padding:18px; background:#a3d2f1;
  font-family:system-ui,"Noto Sans TC";
}
.container{max-width:900px;margin:auto;}
header h1{
  margin:0;padding:10px 14px;background:#fff;border-radius:8px;
  font-size:20px;box-shadow:0 6px 16px rgba(0,0,0,.06);
}

/* é¡¯ç¤ºå€ */
.display{
  position:relative;margin-top:14px;background:#fff;
  border-radius:12px;border:1px solid #e6edff;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
  padding:26px;height:450px;cursor:pointer;
  display:flex;flex-direction:column;
}

.word{
  font-size:38px;font-weight:800;color:#0b63d6;
}

.content{
  margin-top:18px;overflow:auto;flex:1;
}

.def{margin-bottom:18px;line-height:1.6;}
.meaning-zh{font-weight:700;}
.example-en{margin-top:4px;}
.example-zh{margin-top:2px;color:#555;}

.hidden{display:none;}

.icon-btn{
  position:absolute;top:10px;right:10px;
  width:34px;height:34px;border-radius:50%;
  border:none;background:#eef4ff;color:#0b63d6;
  font-size:18px;font-weight:700;cursor:pointer;
}

.progress{
  position:absolute;top:14px;right:54px;
  font-size:14px;color:#666;font-weight:600;
}

/* å…¶ä»–å€å¡Š */
.controls{margin-top:12px;display:flex;gap:8px;}
.controls button{
  padding:8px 12px;border-radius:8px;
  border:1px solid #d7e6fd;background:#fff;
  color:#0b63d6;font-weight:700;
}
.adder{
  margin-top:14px;background:#fff;padding:14px;
  border-radius:10px;border:1px solid #eef3fb;
}
.adder button{
  padding:8px 14px;border-radius:8px;
  border:1px solid #d7e6fd;background:#fff;
  color:#0b63d6;font-weight:700;cursor:pointer;
}

/* æ”¾å¤§æ¨¡å¼ */
.fullscreen .display{
  position:fixed;inset:4%;height:auto;z-index:9999;
}
.fullscreen header,
.fullscreen .controls,
.fullscreen .adder{display:none;}

/* æ–°å¢ï¼šä¸ç†Ÿå–®å­—æŒ‰éˆ•ï¼ˆå³ä¸‹ï¼‰ */
.hard-btn{
  position:absolute;right:14px;bottom:14px;
  padding:8px 12px;border-radius:10px;
  border:1px solid #ffd9cc;background:#fff6f0;
  color:#d65a00;font-weight:800;cursor:pointer;
  box-shadow:0 4px 12px rgba(214,90,0,.08);
}

/* åŒ¯å‡ºæŒ‰éˆ•é¡¯ç¤º count */
#exportHard{min-width:160px;}
</style>
</head>

<body>
<div class="container" id="root">

<header>
  <h1>å–®å­—èƒŒèª¦å·¥å…·</h1>
</header>

<div class="display" id="display">
  <div class="progress" id="progress"></div>
  <button class="icon-btn" id="fsBtn">â›¶</button>
  <div class="word" id="word"></div>
  <div class="content hidden" id="content"></div>

  <!-- æ–°å¢ï¼šåŠ å…¥ä¸ç†Ÿå–®å­—æŒ‰éˆ•ï¼ˆå³ä¸‹ï¼‰ -->
  <button class="hard-btn" id="addHardBtn" title="åŠ å…¥ä¸ç†Ÿå–®å­—">ä¸ç†Ÿ +</button>
</div>

<div class="controls">
  <button id="prev">ä¸Šä¸€å€‹</button>
  <button id="next">ä¸‹ä¸€å€‹</button>

  <!-- æ–°å¢ï¼šåŒ¯å‡ºä¸ç†Ÿå–®å­—æŒ‰éˆ• -->
  <button id="exportHard">åŒ¯å‡ºä¸ç†Ÿå–®å­— (0)</button>
</div>

<div class="adder">
  <strong>åŠ å…¥å–®å­—è¡¨</strong>
  <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
    <!-- æ–°å¢ï¼šå¾å°ˆæ¡ˆä¸­é¸æ“‡ -->
    <select id="vocabSelect" style="min-width:220px;padding:6px;border-radius:6px;border:1px solid #e6eefc;"></select>
    <button id="loadVocab">è¼‰å…¥é¸å®šå–®å­—è¡¨</button>

    <!-- ç¾æœ‰çš„é¸é …ï¼ˆå‰ªè²¼ç°¿ã€é¸æ“‡æª”æ¡ˆï¼‰ -->
    <button id="pasteJson">ğŸ“‹ å¾å‰ªè²¼ç°¿åŠ å…¥</button>
    <button id="openFile">ğŸ“ é¸æ“‡ .json æª”</button>
    <input type="file" id="fileInput" accept=".json" hidden>
  </div>
</div>

</div>

<script>
/* ===== DOM ç¶å®šï¼ˆé—œéµä¿®æ­£ï¼‰ ===== */
const root = document.getElementById("root");
const display = document.getElementById("display");
const wordEl = document.getElementById("word");
const contentEl = document.getElementById("content");
const progress = document.getElementById("progress");
const fsBtn = document.getElementById("fsBtn");
const prev = document.getElementById("prev");
const next = document.getElementById("next");
const pasteJson = document.getElementById("pasteJson");
const openFile = document.getElementById("openFile");
const fileInput = document.getElementById("fileInput");

// æ–°å¢ DOM å…ƒç´ ï¼ˆè®Šæ›´åç¨±ï¼šé¿å…èˆ‡å‡½å¼è¡çªï¼‰
const vocabSelect = document.getElementById("vocabSelect");
const loadVocabBtn = document.getElementById("loadVocab"); // renamed from loadVocab

// æ–°å¢ï¼šä¸ç†Ÿå–®å­—æŒ‰éˆ•èˆ‡åŒ¯å‡ºæŒ‰éˆ•
const addHardBtn = document.getElementById("addHardBtn");
const exportHard = document.getElementById("exportHard");

/* ===== ç‹€æ…‹ ===== */
let words = [];
let idx = 0;
let revealed = false;
let fullscreen = false;

/* ===== ä¸ç†Ÿå–®å­—æ¸…å–®ï¼ˆå„²å­˜åœ¨ localStorageï¼‰ ===== */
let hardList = [];
try{
  hardList = JSON.parse(localStorage.getItem("hardList") || "[]");
  if(!Array.isArray(hardList)) hardList = [];
}catch{
  hardList = [];
}

/* ===== æ ¸å¿ƒæ¸²æŸ“ ===== */
function render(){
  if(!words.length){
    wordEl.textContent = "å°šæœªè¼‰å…¥å–®å­—è¡¨";
    contentEl.innerHTML = "";
    progress.textContent = "";
    return;
  }

  const w = words[idx];
  wordEl.textContent = w.word;
  progress.textContent = `${idx+1} / ${words.length}`;
  contentEl.innerHTML = "";

  w.definitions.forEach(d=>{
    contentEl.innerHTML += `
      <div class="def">
        <div class="meaning-zh">
          ${d.meaning_zh}ï¼ˆ${d.part_of_speech}ï¼‰
        </div>
        <div class="example-en">${d.example_en}</div>
        <div class="example-zh">${d.example_zh}</div>
      </div>
    `;
  });

  contentEl.classList.toggle("hidden", !revealed);
  updateHardButton(); // æ›´æ–°æŒ‰éˆ•é¡¯ç¤ºï¼ˆä¾‹å¦‚æ˜¯å¦å·²åœ¨ä¸ç†Ÿæ¸…å–®ï¼‰
}

/* ===== æ›´æ–°ä¸ç†Ÿå–®å­—é¡¯ç¤ºï¼ˆæŒ‰éˆ•æ–‡å­—èˆ‡åŒ¯å‡ºæŒ‰éˆ•è¨ˆæ•¸ï¼‰ ===== */
function updateHardButton(){
  const count = hardList.length || 0;
  exportHard.textContent = `åŒ¯å‡ºä¸ç†Ÿå–®å­— (${count})`;

  // è‹¥ç›®å‰å–®å­—å·²åœ¨ä¸ç†Ÿæ¸…å–®ï¼Œé¡¯ç¤ºä¸åŒç‹€æ…‹
  if(words.length){
    const cur = words[idx];
    const exists = hardList.some(h => h.word === cur.word);
    addHardBtn.textContent = exists ? "å·²åŠ å…¥" : "ä¸ç†Ÿ +";
    addHardBtn.disabled = exists;
    addHardBtn.title = exists ? "æ­¤å­—å·²åœ¨ä¸ç†Ÿæ¸…å–®" : "åŠ å…¥ä¸ç†Ÿå–®å­—";
    addHardBtn.style.opacity = exists ? 0.7 : 1;
  }else{
    addHardBtn.textContent = "ä¸ç†Ÿ +";
    addHardBtn.disabled = false;
    addHardBtn.title = "åŠ å…¥ä¸ç†Ÿå–®å­—";
    addHardBtn.style.opacity = 1;
  }
}

/* ===== æ“ä½œé‚è¼¯ ===== */
display.onclick = () => {
  if(!words.length) return;
  if(!revealed){
    revealed = true;
  }else{
    idx = (idx + 1) % words.length;
    revealed = false;
  }
  render();
};

prev.onclick = () => {
  if(!words.length) return;
  idx = (idx - 1 + words.length) % words.length;
  revealed = false;
  render();
};

next.onclick = () => {
  if(!words.length) return;
  idx = (idx + 1) % words.length;
  revealed = false;
  render();
};

/* ===== æ”¾å¤§ ===== */
fsBtn.onclick = e => {
  e.stopPropagation();
  fullscreen = !fullscreen;
  root.classList.toggle("fullscreen", fullscreen);
  fsBtn.textContent = fullscreen ? "âœ•" : "â›¶";
};

document.addEventListener("keydown", e=>{
  if(e.key==="Escape" && fullscreen){
    fullscreen=false;
    root.classList.remove("fullscreen");
    fsBtn.textContent="â›¶";
  }
});

/* ===== å‰ªè²¼ç°¿åŠ å…¥ ===== */
pasteJson.onclick = async () => {
  try{
    const text = await navigator.clipboard.readText();
    const data = JSON.parse(text);
    if(!Array.isArray(data)) throw 0;

    words = data;
    idx = 0;
    revealed = false;
    render();
  }catch{
    alert("å‰ªè²¼ç°¿å…§å®¹ä¸æ˜¯æ­£ç¢ºçš„ JSON å–®å­—è¡¨");
  }
};

/* ===== æª”æ¡ˆåŠ å…¥ ===== */
openFile.onclick = () => fileInput.click();

fileInput.onchange = () => {
  const file = fileInput.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      if(!Array.isArray(data)) throw 0;

      words = data;
      idx = 0;
      revealed = false;
      render();
    }catch{
      alert("æª”æ¡ˆå…§å®¹ä¸æ˜¯æ­£ç¢ºçš„ JSON å–®å­—è¡¨");
    }
  };
  reader.readAsText(file);
};

/* ===== å–å¾—å°ˆæ¡ˆä¸­å–®å­—è¡¨æ¸…å–®ä¸¦é¡¯ç¤ºåˆ° select ===== */
async function loadVocabList(){
  try{
    const res = await fetch("vocabulary/list.json");
    if(!res.ok) throw 0;
    const list = await res.json();
    if(!Array.isArray(list)) throw 0;

    // æ¸…ç©ºä¸¦å¡«å…¥é¸é …
    vocabSelect.innerHTML = "";
    list.forEach((item, i) => {
      const opt = document.createElement("option");
      opt.value = item.path; // path ç›¸å°æ–¼ index.html
      opt.textContent = item.label || item.path;
      vocabSelect.appendChild(opt);
    });

    // è‡ªå‹•é¸ç¬¬ä¸€å€‹ä¸¦è¼‰å…¥ï¼ˆè‹¥å°šæœªè¼‰å…¥ä»»ä½•å–®å­—è¡¨ï¼‰
    if(list.length && !words.length){
      vocabSelect.selectedIndex = 0;
      await loadVocabFile(vocabSelect.value); // call renamed function
    }
  }catch(err){
    console.warn("ç„¡æ³•è®€å– vocabulary/list.json", err);
  }
}

/* ===== è¼‰å…¥æŒ‡å®šè·¯å¾‘çš„å–®å­—è¡¨ï¼ˆå¾å°ˆæ¡ˆä¸­çš„æª”æ¡ˆï¼‰ ===== */
async function loadVocabFile(path){ // renamed from loadVocab
  try{
    const res = await fetch(path);
    if(!res.ok) throw 0;
    const data = await res.json();
    if(!Array.isArray(data)) throw 0;

    words = data;
    idx = 0;
    revealed = false;
    render();
  }catch{
    alert("è¼‰å…¥çš„æª”æ¡ˆå…§å®¹ä¸æ˜¯æ­£ç¢ºçš„ JSON å–®å­—è¡¨æˆ–ç„¡æ³•å–å¾—ï¼š" + path);
  }
}

/* é¸å–®æŒ‰éˆ•è¡Œç‚º */
loadVocabBtn.onclick = async (e) => { // use the renamed DOM variable
  e.stopPropagation();
  const path = vocabSelect.value;
  if(!path) return;
  await loadVocabFile(path); // call renamed function
};

/* è‹¥ä½¿ç”¨è€…è®Šæ›´ selectï¼Œå¯è‡ªå‹•è¼‰å…¥ï¼ˆé¸æ“‡æ€§è¡Œç‚ºï¼‰ */
vocabSelect.onchange = async () => {
  // ä»¥ä½¿ç”¨è€…ä¸»å‹•é»æ“Šã€Œè¼‰å…¥é¸å®šå–®å­—è¡¨ã€ç‚ºä¸»ï¼›è‹¥æƒ³è¦æ”¹æˆå³æ™‚è¼‰å…¥å¯å–æ¶ˆä¸‹é¢è¨»è§£ï¼š
  // await loadVocabFile(vocabSelect.value);
};

/* ===== ä¸ç†Ÿå–®å­—ï¼šåŠ å…¥èˆ‡åŒ¯å‡º ===== */
function saveHardList(){
  localStorage.setItem("hardList", JSON.stringify(hardList));
}

addHardBtn.addEventListener("click", e => {
  e.stopPropagation(); // é˜²æ­¢è§¸ç™¼ display çš„é»æ“Š
  if(!words.length) return alert("å°šæœªè¼‰å…¥ä»»ä½•å–®å­—");
  const cur = words[idx];

  // ä»¥ word æ¬„ä½ä½œç‚ºå”¯ä¸€éµï¼Œé¿å…é‡è¤‡
  if(hardList.some(h => h.word === cur.word)){
    updateHardButton();
    return;
  }

  // æ¨å…¥æ•´å€‹ç‰©ä»¶ï¼ˆå¯ä¾éœ€æ±‚åªå­˜éƒ¨åˆ†æ¬„ä½ï¼‰
  hardList.push(cur);
  saveHardList();
  updateHardButton();
});

/* åŒ¯å‡ºä¸ç†Ÿå–®å­— JSON æª” */
exportHard.addEventListener("click", e => {
  e.stopPropagation();
  if(!hardList.length) return alert("ä¸ç†Ÿå–®å­—æ¸…å–®ç‚ºç©º");
  const blob = new Blob([JSON.stringify(hardList, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "hard_words.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* åˆå§‹ï¼šå˜—è©¦è®€å– manifestï¼Œä¸¦ render */
loadVocabList().finally(()=>{ render(); updateHardButton(); });
</script>
</body>
</html>
